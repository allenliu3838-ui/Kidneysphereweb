<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‘å¸ƒç—…ä¾‹ Â· KidneySphere</title>
  <meta name="description" content="KidneySphere Ã— KidneySphere AI">
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=20260213_001" />
</head>
<body>
  <header class="nav"></header>

  <main>
    
<section class="hero">
  <div class="container">
    <div class="card" style="max-width:860px;margin:0 auto">
      <span class="badge" id="postBadge">å‘å¸ƒç—…ä¾‹</span>
      <h2 style="margin-top:10px" id="postTitle">ç™»å½•åå¯ç«‹å³å‘å¸ƒ</h2>
      <p id="postIntro">å¡«å†™æ ‡é¢˜ã€æ‘˜è¦ä¸æ ‡ç­¾ï¼Œå¯æ‹–æ‹½/ç²˜è´´æ·»åŠ é™„ä»¶ï¼ˆå›¾ç‰‡/PDF/Wordï¼‰ã€‚å‘å¸ƒåå³å¯åœ¨ç¤¾åŒºä¸­è¢«æŸ¥çœ‹ä¸è®¨è®ºã€‚</p>

      <!-- Doctor verification gate (Channel A: invite code). Filled by JS. -->
      <div id="doctorGate" class="note" style="display:none; margin-top:12px"></div>

      <form id="caseForm">
        <label>é€‰æ‹©æ¿å—</label>
        <select class="input" name="board" id="sectionSelect">
          <option value="glom">è‚¾å°çƒä¸é—´è´¨æ€§è‚¾ç—…ç¤¾åŒº</option>
          <option value="tx">è‚¾ç§»æ¤å†…ç§‘ç¤¾åŒº</option>
          <option value="icu">é‡ç—‡è‚¾å†…ï¼ˆç”µè§£è´¨/é…¸ç¢±ï¼‰ä¸é€æç¤¾åŒº</option>
          <option value="peds">å„¿ç«¥è‚¾è„ç—…ç¤¾åŒº</option>
          <option value="rare">ç½•è§è‚¾è„ç—…ç¤¾åŒº</option>
        </select>
        <div class="small" id="sectionHint" style="margin-top:6px">åˆ†åŒºå¯ç”±ç®¡ç†å‘˜æ‰©å®¹ï¼›æ–°å¢åä¼šè‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œã€‚</div>

        <label id="titleLabel">ç—…ä¾‹æ ‡é¢˜</label>
        <input class="input" name="title" placeholder="ä¾‹å¦‚ï¼šIgAN åˆå¹¶è‚¾ç—…ç»¼åˆå¾ï¼Œå…ç–«æ²»ç–—å†³ç­–" required />

        <label id="summaryLabel">ç®€è¦æ‘˜è¦ï¼ˆ200-600 å­—ä¸ºä½³ï¼‰</label>
        <textarea class="input" name="summary" rows="6" placeholder="è¯·å†™å‡ºç—…ä¾‹äº®ç‚¹ï¼šèƒŒæ™¯ã€å…³é”®æ£€æŸ¥ã€è¯Šæ–­éš¾ç‚¹ã€æ²»ç–—ç­–ç•¥ã€éšè®¿ç»“å±€â€¦" required></textarea>

        <div id="aiPostTools" style="margin-top:12px" hidden></div>

        <label>æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
        <input class="input" name="tags" placeholder="ä¾‹å¦‚ï¼šIgAN, æ–°è¯, è¡¥ä½“, ç—…ç†" />

        <div class="attach-tools" style="margin-top:12px">
          <input id="casePostAttachInput" type="file" multiple hidden accept="image/*,application/pdf,.pdf,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
          <button class="btn tiny" type="button" id="casePostPickAttachBtn">ğŸ“ æ·»åŠ å›¾ç‰‡/æ–‡ä»¶</button>
          <button class="btn tiny" type="button" id="casePostClearAttachBtn">æ¸…ç©º</button>
          <span class="attach-hint">æ”¯æŒå›¾ç‰‡ / PDF / Wordï¼ˆå•ä¸ªâ‰¤20MBï¼Œæœ€å¤š 9 ä¸ªï¼›å¯ç›´æ¥æ‹–æ‹½/ç²˜è´´åˆ°æ‘˜è¦è¾“å…¥æ¡†ï¼‰</span>
        </div>
        <div id="casePostAttachPreview" class="attach-list"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
          <button class="btn primary" type="submit">å‘å¸ƒ</button>
          <a class="btn" id="backBtn" href="community.html">è¿”å›ç¤¾åŒº</a>
        </div>
      </form>

      <div class="hr"></div>
      <div class="note">
        <b>æç¤ºï¼š</b>å‘å¸ƒç—…ä¾‹éœ€å®ŒæˆåŒ»ç”Ÿè®¤è¯ã€‚æ”¯æŒ <a href="verify-doctor.html"><b>é‚€è¯·ç å¿«é€Ÿè®¤è¯</b></a> ä¸ <b>äººå·¥å®¡æ ¸è®¤è¯</b> ä¸¤ç§æ–¹å¼ã€‚
      </div>
    </div>
  </div>
</section>

<script type="module">
  import { supabase, ensureAuthed, isConfigured, toast, getSession, getUserProfile, normalizeRole, isAdminRole } from './supabaseClient.js?v=20260128_030';
  import { mountKSEditor } from './ks_editor.js?v=20260213_001';

  const form = document.getElementById('caseForm');
  const sectionSelect = document.getElementById('sectionSelect');
  const sectionHint = document.getElementById('sectionHint');

  // Mode: case (default) / research / literature
  const qs = new URLSearchParams(location.search);
  const mode = (qs.get('c') || 'case').toString().toLowerCase();
  const presetBoard = (qs.get('board') || qs.get('b') || '').toString().trim();

  const postBadge = document.getElementById('postBadge');
  const postTitle = document.getElementById('postTitle');
  const postIntro = document.getElementById('postIntro');
  const titleLabel = document.getElementById('titleLabel');
  const summaryLabel = document.getElementById('summaryLabel');
  const backBtn = document.getElementById('backBtn');

  const aiPostTools = document.getElementById('aiPostTools');

  function ensureBoardOption(value, label){
    if(!sectionSelect) return;
    const exists = Array.from(sectionSelect.options || []).some(o => String(o.value) === String(value));
    if(exists) return;
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = label || value;
    sectionSelect.appendChild(opt);
  }

  // Apply mode-specific UI (keep posting pipelineç»Ÿä¸€èµ° cases è¡¨)
  (function applyMode(){
    if(mode === 'research'){
      postBadge && (postBadge.textContent = 'å‘å¸ƒç§‘ç ”è®¨è®º');
      postTitle && (postTitle.textContent = 'å‘å¸ƒä¸€æ¡ç§‘ç ”è®¨è®ºä¸»é¢˜');
      postIntro && (postIntro.textContent = 'ç”¨äºä¸´åºŠ/åŸºç¡€ç ”ç©¶çš„æ–¹æ¡ˆè®¨è®ºã€ç»Ÿè®¡è§£è¯»ã€æ•°æ®å¤ç°ä¸æƒ³æ³•ç¢°æ’ã€‚æ”¯æŒé™„ä»¶ï¼ˆå›¾ç‰‡/PDF/Wordï¼‰ï¼Œå¯æ‹–æ‹½/ç²˜è´´ã€‚');
      titleLabel && (titleLabel.textContent = 'ä¸»é¢˜æ ‡é¢˜');
      summaryLabel && (summaryLabel.textContent = 'ç®€è¦æ‘˜è¦ï¼ˆå»ºè®® 200-800 å­—ï¼‰');
      ensureBoardOption('research', 'ç§‘ç ”è®¨è®º');
      sectionSelect && (sectionSelect.value = 'research');
      // Hide board picker (å›ºå®šåˆ° research)
      if(sectionSelect){
        const lb = sectionSelect.previousElementSibling;
        if(lb && lb.tagName === 'LABEL') lb.style.display = 'none';
        sectionSelect.style.display = 'none';
      }
      if(sectionHint) sectionHint.style.display = 'none';
      if(backBtn) backBtn.href = 'board.html?c=research';
    }else if(mode === 'literature'){
      postBadge && (postBadge.textContent = 'å‘å¸ƒæ–‡çŒ®è®¨è®º');
      postTitle && (postTitle.textContent = 'å‘å¸ƒä¸€æ¡æ–‡çŒ®å­¦ä¹ ï¼ˆJournal Clubï¼‰ä¸»é¢˜');
      postIntro && (postIntro.textContent = 'å¯åˆ†äº«æŒ‡å—/ç»¼è¿°/ä¸´åºŠè¯•éªŒ/æ–°è¯æœºåˆ¶å¹¶ç»„ç»‡è®¨è®ºã€‚æ”¯æŒä¸Šä¼  PDF/å›¾ç‰‡ï¼Œæ”¯æŒæ‹–æ‹½/ç²˜è´´ã€‚');
      titleLabel && (titleLabel.textContent = 'æ–‡çŒ®/ä¸»é¢˜æ ‡é¢˜');
      summaryLabel && (summaryLabel.textContent = 'è¦ç‚¹æ‘˜è¦ï¼ˆå»ºè®® 200-800 å­—ï¼‰');
      ensureBoardOption('literature', 'æ–‡çŒ®å­¦ä¹ ï¼ˆJournal Clubï¼‰');
      sectionSelect && (sectionSelect.value = 'literature');
      // Hide board picker (å›ºå®šåˆ° literature)
      if(sectionSelect){
        const lb = sectionSelect.previousElementSibling;
        if(lb && lb.tagName === 'LABEL') lb.style.display = 'none';
        sectionSelect.style.display = 'none';
      }
      if(sectionHint) sectionHint.style.display = 'none';
      if(backBtn) backBtn.href = 'board.html?c=literature';
    }else{
      // Default: case
      postBadge && (postBadge.textContent = 'å‘å¸ƒç—…ä¾‹');
      if(backBtn) backBtn.href = 'community.html';
    }
  })();

	  // Attachments picker (for the case itself)
	  const attachInput = document.getElementById('casePostAttachInput');
	  const attachPickBtn = document.getElementById('casePostPickAttachBtn');
	  const attachClearBtn = document.getElementById('casePostClearAttachBtn');
	  const attachPreview = document.getElementById('casePostAttachPreview');
	  const summaryInput = form?.querySelector('textarea[name="summary"]');

	  // Word-like rich editor (sync plain text back to textarea for legacy logic)
	  const summaryEditor = summaryInput ? mountKSEditor(summaryInput, {
	    mode: 'comment',
	    placeholder: 'è¯·åœ¨è¿™é‡Œå†™æ‘˜è¦ / è®¨è®ºå†…å®¹ï¼ˆæ”¯æŒåŠ ç²—ã€é¢œè‰²ã€åˆ—è¡¨ï¼›ä» Word ç²˜è´´å¯è‡ªåŠ¨æ’ç‰ˆï¼‰',
	    syncToTextarea: true,
	  }) : null;
	  const summaryDropEl = summaryEditor ? summaryEditor.surface : summaryInput;
	  const summaryHoverEl = summaryEditor ? summaryEditor.root : summaryInput;

	  let attachPicks = []; // {id, file}

	  function safeFilename(name){
	    // Supabase Storage object keys should be URL-safe (ASCII). Non-ASCII characters
	    // (e.g. Chinese) can trigger "Invalid key" errors in supabase-js.
	    const raw = String(name || 'file').trim();
	    const dot = raw.lastIndexOf('.');
	    const stemRaw = dot > 0 ? raw.slice(0, dot) : raw;
	    const extRaw = dot > 0 ? raw.slice(dot + 1) : '';
	    let stem = stemRaw
	      .normalize('NFKD')
	      .replace(/\s+/g, '_')
	      .replace(/[^a-zA-Z0-9_-]/g, '_')
	      .replace(/_+/g, '_')
	      .replace(/^_+|_+$/g, '')
	      .slice(0, 80);
	    if(!stem) stem = 'file';
	    const ext = extRaw.toLowerCase().replace(/[^a-z0-9]/g, '').slice(0, 10);
	    return ext ? `${stem}.${ext}` : stem;
	  }

	  function guessKindFromMime(mime, name){
	    const m = String(mime || '').toLowerCase();
	    const n = String(name || '').toLowerCase();
	    if(m.startsWith('image/')) return 'image';
	    if(m === 'application/pdf' || n.endsWith('.pdf')) return 'pdf';
	    if(m.includes('word') || n.endsWith('.doc') || n.endsWith('.docx')) return 'doc';
	    return 'file';
	  }

	  function renderAttachDraft(){
	    if(!attachPreview) return;
	    if(!attachPicks.length){
	      attachPreview.innerHTML = '';
	      return;
	    }
	    attachPreview.innerHTML = attachPicks.map(p=>{
	      const f = p.file;
	      const kind = guessKindFromMime(f?.type, f?.name);
	      const icon = kind === 'image' ? 'ğŸ–¼ï¸' : (kind === 'pdf' ? 'ğŸ“„' : (kind === 'doc' ? 'ğŸ“' : 'ğŸ“'));
	      const sizeMB = f && f.size ? (f.size/1024/1024).toFixed(1) : '';
	      const label = `${icon} ${f?.name || 'é™„ä»¶'}${sizeMB ? ` Â· ${sizeMB}MB` : ''}`;
	      return `<span class="file-chip">${label} <button type="button" class="btn tiny" data-attach-remove="${p.id}" style="margin-left:6px">ç§»é™¤</button></span>`;
	    }).join(' ');
	  }

	  function clearAttachDraft(){
	    attachPicks = [];
	    if(attachInput) attachInput.value = '';
	    renderAttachDraft();
	    if(attachClearBtn) attachClearBtn.disabled = true;
	  }

	  function addAttachFiles(files){
	    const arr = Array.from(files || []).filter(Boolean);
	    if(!arr.length) return;
	    const MAX = 9;
	    const MAX_BYTES = 20 * 1024 * 1024;
	    let added = 0;
	    for(const f of arr){
	      if(attachPicks.length >= MAX) break;
	      if(f.size && f.size > MAX_BYTES){
	        toast('é™„ä»¶è¿‡å¤§', `${f.name || 'æ–‡ä»¶'} è¶…è¿‡ 20MBï¼Œå·²è·³è¿‡ã€‚`, 'err');
	        continue;
	      }
	      const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
	      attachPicks.push({ id, file: f });
	      added++;
	    }
	    if(added){
	      renderAttachDraft();
	      if(attachClearBtn) attachClearBtn.disabled = false;
	    }
	  }

	  // Bind picker UI
	  if(attachClearBtn) attachClearBtn.disabled = true;
	  attachPickBtn?.addEventListener('click', ()=> attachInput?.click());
	  attachClearBtn?.addEventListener('click', clearAttachDraft);
	  attachInput?.addEventListener('change', (e)=> addAttachFiles(e.target.files));
	  attachPreview?.addEventListener('click', (e)=>{
	    const btn = e.target?.closest?.('[data-attach-remove]');
	    if(!btn) return;
	    const id = String(btn.getAttribute('data-attach-remove') || '');
	    attachPicks = attachPicks.filter(x=>x.id !== id);
	    renderAttachDraft();
	    if(attachClearBtn) attachClearBtn.disabled = !attachPicks.length;
	  });

	  // Drag & drop / paste to summary input
	  (function bindPasteDrop(){
	    if(!summaryDropEl) return;
	    const targets = [summaryDropEl, attachPreview, form].filter(Boolean);
	    const setHover = (on)=>{
	      try{ (summaryHoverEl || summaryDropEl).classList.toggle('drop-hover', !!on); }catch(_e){}
	    };
	    targets.forEach(t=>{
	      t.addEventListener('dragover', (e)=>{
	        const types = Array.from(e.dataTransfer?.types || []);
	        if(types.includes('Files')){
	          e.preventDefault();
	          setHover(true);
	        }
	      });
	      t.addEventListener('dragleave', ()=> setHover(false));
	      t.addEventListener('drop', (e)=>{
	        const files = e.dataTransfer?.files;
	        if(files && files.length){
	          e.preventDefault();
	          setHover(false);
	          addAttachFiles(files);
	          toast('å·²æ·»åŠ é™„ä»¶', `å·²æ·»åŠ  ${files.length} ä¸ªæ–‡ä»¶`, 'ok');
	        }
	      });
	    });
	    summaryDropEl.addEventListener('paste', (e)=>{
	      const dt = e.clipboardData;
	      if(!dt) return;
	      const files = [];
	      for(const item of Array.from(dt.items || [])){
	        if(item.kind === 'file'){
	          const f = item.getAsFile();
	          if(f) files.push(f);
	        }
	      }
	      if(!files.length) return;
	      const hasText = Boolean(dt.getData('text/plain'));
	      if(!hasText) e.preventDefault();
	      addAttachFiles(files);
	      toast('å·²æ·»åŠ é™„ä»¶', 'å·²ä»å‰ªè´´æ¿æ·»åŠ ', 'ok');
	    });
	  })();

  // --- AI Assist (Stage1 Free) for posting ---

  function detectPrivacyFlags(text){
    const s = String(text || '');
    const flags = [];
    // Mainland China mobile numbers
    if(/(?:\+?86)?1[3-9]\d{9}/.test(s)) flags.push('ç–‘ä¼¼æ‰‹æœºå·');
    // PRC ID number (rough)
    if(/\b\d{17}[0-9Xx]\b/.test(s)) flags.push('ç–‘ä¼¼èº«ä»½è¯å·');
    // Hospitalization number keywords
    if(/(ä½é™¢å·|é—¨è¯Šå·|ç—…æ¡ˆå·|å°±è¯Šå·|ID[:ï¼š]?)/i.test(s)) flags.push('ç–‘ä¼¼å°±è¯Š/ä½é™¢ç¼–å·');
    return flags;
  }

  async function copyText(text){
    const t = String(text || '');
    if(!t.trim()) return false;
    try{
      await navigator.clipboard.writeText(t);
      return true;
    }catch(_e){
      try{
        const ta = document.createElement('textarea');
        ta.value = t;
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      }catch(_e2){
        return false;
      }
    }
  }

  function modeLabel(){
    if(mode === 'research') return 'ç§‘ç ”è®¨è®º';
    if(mode === 'literature') return 'æ–‡çŒ®å­¦ä¹ ï¼ˆJournal Clubï¼‰';
    return 'ç—…ä¾‹è®¨è®º';
  }

  function selectedBoardLabel(){
    try{
      const opt = sectionSelect?.options?.[sectionSelect.selectedIndex];
      return String(opt?.textContent || sectionSelect?.value || '').trim();
    }catch(_e){
      return String(sectionSelect?.value || '').trim();
    }
  }

  function summarizeDraftAttachments(){
    if(!attachPicks || !attachPicks.length) return 'æ— ';
    return attachPicks.map(p=>{
      const f = p?.file;
      if(!f) return null;
      const kind = guessKindFromMime(f.type, f.name);
      const sizeMB = f.size ? (f.size/1024/1024).toFixed(1) : '';
      return `- ${f.name || 'é™„ä»¶'}ï¼ˆ${kind}${sizeMB ? 'ï¼Œ' + sizeMB + 'MB' : ''}ï¼‰`;
    }).filter(Boolean).join('\n');
  }

  function buildAiPostContextText(){
    if(!form) return '';
    const fd = new FormData(form);
    const boardKey = String(fd.get('board') || '').trim();
    const title = String(fd.get('title') || '').trim();
    const summary = String(fd.get('summary') || '').trim();
    const tagsRaw = String(fd.get('tags') || '').trim();

    const lines = [];
    lines.push(`ã€å‘å¸ƒç±»å‹ã€‘${modeLabel()}`);
    lines.push(`ã€æ¿å—ã€‘${selectedBoardLabel()}${boardKey ? `ï¼ˆkey: ${boardKey}ï¼‰` : ''}`);
    lines.push('');
    lines.push('ã€å½“å‰è‰ç¨¿ã€‘');
    lines.push(`æ ‡é¢˜ï¼š${title || 'ï¼ˆæœªå¡«å†™ï¼‰'}`);
    lines.push('æ‘˜è¦/è¦ç‚¹ï¼š');
    lines.push(summary || 'ï¼ˆæœªå¡«å†™ï¼‰');
    lines.push(`æ ‡ç­¾ï¼š${tagsRaw || 'ï¼ˆæœªå¡«å†™ï¼‰'}`);
    lines.push('');
    lines.push('ã€å·²é€‰æ‹©é™„ä»¶ï¼ˆä»…æ–‡ä»¶å/ç±»å‹ï¼‰ã€‘');
    lines.push(summarizeDraftAttachments());
    lines.push('');
    lines.push('ã€æé†’ã€‘è¯·ç¡®è®¤ä»¥ä¸Šå†…å®¹å·²å»æ ‡è¯†åŒ–ï¼ˆå§“å/ç”µè¯/ä½é™¢å·/èº«ä»½è¯ç­‰ï¼‰ã€‚å¦‚å‘ç°ç–‘ä¼¼éšç§ä¿¡æ¯ï¼Œè¯·å…ˆåˆ é™¤æˆ–æ‰“ç åå†å¤åˆ¶åˆ°å¤–éƒ¨AIã€‚');
    return lines.join('\n');
  }

  const AI_POST_PROMPT_VERSION = 'stage1_free_post_v1';

  function buildAiPostPrompt(){
    const targetLen = (mode === 'case') ? '200-600' : '200-800';
    return [
      'ä½ æ˜¯åŒ»å­¦å­¦æœ¯å¹³å°çš„ç¼–è¾‘åŠ©æ‰‹ã€‚ç›®æ ‡ï¼šæŠŠä¸‹é¢çš„è‰ç¨¿æ•´ç†æˆé€‚åˆå‘å¸ƒåœ¨è‚¾è„ç—…å­¦æœ¯ç¤¾åŒºçš„å¸–å­ã€‚',
      'è¯·ä»…åœ¨æˆ‘æä¾›ä¿¡æ¯èŒƒå›´å†…æ•´ç†ï¼Œä¸è¦ç¼–é€ æœªå‡ºç°çš„ä¿¡æ¯ã€‚ä¸å¾—è¾“å‡ºä¸ªä½“åŒ–å¤„æ–¹æˆ–åŒ»ç–—å»ºè®®ã€‚',
      '',
      'è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼ˆä¾¿äºæˆ‘è‡ªåŠ¨å¡«å›ç½‘é¡µï¼‰ï¼š',
      'æ ‡é¢˜ï¼š...ï¼ˆä¸­æ–‡ä¸ºä¸»ï¼Œå¿…è¦æ—¶å¯åŠ è‹±æ–‡ç¼©å†™ï¼‰',
      `æ‘˜è¦ï¼š...ï¼ˆå»ºè®® ${targetLen} å­—ï¼Œçªå‡ºèƒŒæ™¯/å…³é”®æ£€æŸ¥/è¯Šæ–­éš¾ç‚¹/æ²»ç–—ç­–ç•¥/éšè®¿ç»“å±€ï¼›ç¼ºå¤±å¤„å†™â€œå¾…è¡¥å……â€ï¼‰`,
      'æ ‡ç­¾ï¼štag1, tag2, tag3ï¼ˆæœ€å¤š 8 ä¸ªï¼Œç”¨é€—å·åˆ†éš”ï¼‰',
      'è®¨è®ºé—®é¢˜ï¼š1) ... 2) ... 3) ...ï¼ˆå¯é€‰ï¼Œ3-6 æ¡ï¼‰',
      '',
      'é¢å¤–è¦æ±‚ï¼š',
      '- è¯­è¨€é£æ ¼ç¨³é‡ã€å­¦æœ¯ã€æ¸…æ™°ï¼Œå¯ç›´æ¥ç”¨äºç—…ä¾‹è®¨è®ºã€‚',
      '- å¦‚å‘ç°å¯èƒ½éšç§ä¿¡æ¯ï¼Œè¯·åœ¨è¾“å‡ºæœ«å°¾åŠ ä¸€è¡Œï¼šéšç§æç¤ºï¼šxxxï¼ˆå»ºè®®åˆ é™¤ï¼‰ã€‚',
      '',
      '---',
      buildAiPostContextText(),
    ].join('\n');
  }

  function buildAiPostStructPrompt(){
    return [
      'ä½ æ˜¯åŒ»å­¦ç—…ä¾‹ç»“æ„åŒ–æ•´ç†åŠ©æ‰‹ã€‚è¯·ä»…åŸºäºæˆ‘æä¾›çš„è‰ç¨¿ä¿¡æ¯æ•´ç†ç»“æ„åŒ–æ¨¡æ¿ï¼Œä¸è¦æ¨æ–­ã€ä¸è¦è¡¥å…¨ç¼ºå¤±ä¿¡æ¯ã€‚',
      'è¾“å‡ºä¸º Markdownï¼ˆä¸è¦é™„åŠ å¤šä½™è§£é‡Šï¼‰ã€‚ç¼ºå¤±ä¿¡æ¯è¯·æ ‡æ³¨â€œå¾…è¡¥å……â€ã€‚',
      '',
      'è¯·æŒ‰ä»¥ä¸‹ç»“æ„è¾“å‡ºï¼š',
      '## ä¸»è¯‰',
      '## ç°ç—…å²ï¼ˆæŒ‰æ—¶é—´çº¿ï¼‰',
      '## æ—¢å¾€å²/ç”¨è¯å²ï¼ˆå¦‚æœ‰ï¼‰',
      '## å…³é”®æ£€æŸ¥ï¼ˆåŒ–éªŒ/å½±åƒ/ç—…ç†ï¼‰',
      '## è¯Šæ–­æ€è·¯ï¼ˆé‰´åˆ«è¦ç‚¹ï¼‰',
      '## æ²»ç–—ç»è¿‡ä¸ååº”',
      '## éšè®¿ä¸ç»“å±€',
      '## è®¨è®ºé—®é¢˜ï¼ˆ3-6æ¡ï¼‰',
      '',
      'é‡è¦ï¼šä¸å¾—è¾“å‡ºå…·ä½“å¤„æ–¹å»ºè®®ï¼›ä»…æ•´ç†æ–‡æœ¬ä¿¡æ¯ä¸è®¨è®ºç‚¹ã€‚',
      '',
      '---',
      buildAiPostContextText(),
    ].join('\n');
  }

  function parseAiOutput(text){
    const s = String(text || '');
    const out = { title: '', summary: '', tags: '' };

    const mTitle = s.match(/(?:^|\n)\s*(?:æ ‡é¢˜|Title)\s*[:ï¼š]\s*(.+)/i);
    if(mTitle) out.title = String(mTitle[1] || '').trim();

    const mSummary = s.match(/(?:^|\n)\s*(?:æ‘˜è¦|Summary)\s*[:ï¼š]\s*([\s\S]+?)(?=\n\s*(?:æ ‡ç­¾|Tags?|è®¨è®ºé—®é¢˜|Questions?)\s*[:ï¼š]|$)/i);
    if(mSummary) out.summary = String(mSummary[1] || '').trim();

    const mTags = s.match(/(?:^|\n)\s*(?:æ ‡ç­¾|Tags?)\s*[:ï¼š]\s*(.+)/i);
    if(mTags) out.tags = String(mTags[1] || '').replace(/[ï¼›;]/g, ',').trim();

    return out;
  }

  function mountAiPostTools(){
    if(!aiPostTools) return;

    aiPostTools.innerHTML = `
      <details class="note" open>
        <summary style="cursor:pointer"><b>AI è¾…åŠ©å‘å¸ƒï¼ˆå…è´¹ï¼‰</b> <span class="small muted">ï¼ˆç½‘ç«™ä¸è°ƒç”¨AIï¼›å¤åˆ¶åˆ°ä»»æ„å…è´¹AIç”Ÿæˆåç²˜è´´å›å¡«ï¼‰</span></summary>
        <div style="margin-top:10px">
          <div class="small muted" style="margin-bottom:8px">
            å»ºè®®å…ˆåœ¨ä¸Šæ–¹â€œæ‘˜è¦â€æ¡†é‡Œå†™è¦ç‚¹/ç²˜è´´åŸå§‹ææ–™ï¼Œå†ç‚¹å‡»å¤åˆ¶æç¤ºè¯ï¼Œè®©å…è´¹AIå¸®ä½ æ•´ç†æˆæ›´é€‚åˆå‘å¸ƒçš„æ ‡é¢˜ã€æ‘˜è¦ä¸æ ‡ç­¾ã€‚
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
            <button class="btn tiny" type="button" id="aiPostCopyBtn">å¤åˆ¶æç¤ºè¯+å½“å‰è‰ç¨¿ï¼ˆæ ‡é¢˜/æ‘˜è¦/æ ‡ç­¾ï¼‰</button>
            <button class="btn tiny" type="button" id="aiPostCopyStructBtn">å¤åˆ¶ç»“æ„åŒ–æ¨¡æ¿æç¤ºè¯+è‰ç¨¿</button>
          </div>

          <label class="small muted">ç²˜è´´ AI è¾“å‡ºï¼ˆæ”¯æŒæ ¼å¼ï¼šæ ‡é¢˜ï¼šâ€¦ æ‘˜è¦ï¼šâ€¦ æ ‡ç­¾ï¼šâ€¦ï¼‰</label>
          <textarea class="input" id="aiPostOutput" rows="8" placeholder="æŠŠå…è´¹AIç”Ÿæˆçš„å†…å®¹ç²˜è´´åˆ°è¿™é‡Œâ€¦"></textarea>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center">
            <button class="btn primary" type="button" id="aiPostFillBtn">è‡ªåŠ¨å¡«å……åˆ°è¡¨å•</button>
            <button class="btn" type="button" id="aiPostReplaceSummaryBtn">ç”¨è¿™æ®µæ–‡å­—æ›¿æ¢æ‘˜è¦</button>
            <button class="btn" type="button" id="aiPostAppendSummaryBtn">è¿½åŠ åˆ°æ‘˜è¦æœ«å°¾</button>
            <span class="small muted" id="aiPostHint"></span>
          </div>

          <div class="small muted" style="margin-top:10px">
            æé†’ï¼šä¸è¦åŒ…å«æ‚£è€…å§“å/ç”µè¯/ä½é™¢å·/èº«ä»½è¯ç­‰å¯è¯†åˆ«ä¿¡æ¯ã€‚è‹¥åŒ…å«ï¼Œè¯·å…ˆåˆ é™¤æˆ–æ‰“ç ã€‚
          </div>
        </div>
      </details>
    `;

    const copyBtn = document.getElementById('aiPostCopyBtn');
    const copyStructBtn = document.getElementById('aiPostCopyStructBtn');
    const outTa = document.getElementById('aiPostOutput');
    const fillBtn = document.getElementById('aiPostFillBtn');
    const replaceBtn = document.getElementById('aiPostReplaceSummaryBtn');
    const appendBtn = document.getElementById('aiPostAppendSummaryBtn');
    const hint = document.getElementById('aiPostHint');

    const titleEl = form?.querySelector('input[name="title"]');
    const summaryEl = form?.querySelector('textarea[name="summary"]');
    const tagsEl = form?.querySelector('input[name="tags"]');

    function setHint(msg){
      if(hint) hint.textContent = msg || '';
    }

    copyBtn?.addEventListener('click', async ()=>{
      const text = buildAiPostPrompt();
      const flags = detectPrivacyFlags(text);
      if(flags.length){
        const ok = confirm(`æ£€æµ‹åˆ°å¯èƒ½éšç§ä¿¡æ¯ï¼š${flags.join('ã€')}\n\nå»ºè®®å…ˆåˆ é™¤/æ‰“ç åå†å¤åˆ¶åˆ°å¤–éƒ¨AIã€‚\n\nä»è¦å¤åˆ¶å—ï¼Ÿ`);
        if(!ok) return;
      }
      const ok = await copyText(text);
      if(ok){
        toast('å·²å¤åˆ¶', 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚å¯ç²˜è´´åˆ°ä»»æ„å…è´¹AIç”Ÿæˆå‘å¸ƒæ–‡æ¡ˆã€‚', 'ok');
        setHint('å·²å¤åˆ¶æç¤ºè¯ã€‚');
      }else{
        toast('å¤åˆ¶å¤±è´¥', 'æµè§ˆå™¨å¯èƒ½é˜»æ­¢äº†å‰ªè´´æ¿æƒé™ã€‚è¯·æ‰‹åŠ¨é€‰ä¸­å¤åˆ¶ã€‚', 'err');
        setHint('å¤åˆ¶å¤±è´¥ã€‚');
      }
    });

    copyStructBtn?.addEventListener('click', async ()=>{
      const text = buildAiPostStructPrompt();
      const flags = detectPrivacyFlags(text);
      if(flags.length){
        const ok = confirm(`æ£€æµ‹åˆ°å¯èƒ½éšç§ä¿¡æ¯ï¼š${flags.join('ã€')}\n\nå»ºè®®å…ˆåˆ é™¤/æ‰“ç åå†å¤åˆ¶åˆ°å¤–éƒ¨AIã€‚\n\nä»è¦å¤åˆ¶å—ï¼Ÿ`);
        if(!ok) return;
      }
      const ok = await copyText(text);
      if(ok){
        toast('å·²å¤åˆ¶', 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚å¯ç²˜è´´åˆ°ä»»æ„å…è´¹AIç”Ÿæˆç»“æ„åŒ–æ¨¡æ¿ã€‚', 'ok');
        setHint('å·²å¤åˆ¶ç»“æ„åŒ–æç¤ºè¯ã€‚');
      }else{
        toast('å¤åˆ¶å¤±è´¥', 'æµè§ˆå™¨å¯èƒ½é˜»æ­¢äº†å‰ªè´´æ¿æƒé™ã€‚è¯·æ‰‹åŠ¨é€‰ä¸­å¤åˆ¶ã€‚', 'err');
        setHint('å¤åˆ¶å¤±è´¥ã€‚');
      }
    });

    fillBtn?.addEventListener('click', ()=>{
      const txt = String(outTa?.value || '').trim();
      if(!txt){ toast('å†…å®¹ä¸ºç©º', 'è¯·å…ˆç²˜è´´ AI è¾“å‡ºã€‚', 'err'); return; }

      const flags = detectPrivacyFlags(txt);
      if(flags.length){
        const ok = confirm(`ç²˜è´´å†…å®¹ä¸­æ£€æµ‹åˆ°ï¼š${flags.join('ã€')}\n\nå»ºè®®å…ˆåˆ é™¤/æ‰“ç åå†å¡«å……ã€‚\n\nä»è¦ç»§ç»­å—ï¼Ÿ`);
        if(!ok) return;
      }

      const parsed = parseAiOutput(txt);
      let filled = 0;
      if(parsed.title && titleEl){ titleEl.value = parsed.title; filled++; }
      if(parsed.summary && summaryEl){ summaryEl.value = parsed.summary; filled++; }
      if(parsed.tags && tagsEl){ tagsEl.value = parsed.tags; filled++; }

      if(!filled){
        toast('æœªè¯†åˆ«åˆ°å­—æ®µ', 'è¯·ç¡®ä¿ AI è¾“å‡ºåŒ…å«ï¼šæ ‡é¢˜ï¼šâ€¦ æ‘˜è¦ï¼šâ€¦ æ ‡ç­¾ï¼šâ€¦', 'err');
        setHint('æœªè¯†åˆ«åˆ°å­—æ®µã€‚');
      }else{
        toast('å·²å¡«å……', 'å·²å°†è¯†åˆ«å‡ºçš„å­—æ®µå†™å…¥è¡¨å•ï¼Œå¯å†æ‰‹åŠ¨å¾®è°ƒã€‚', 'ok');
        setHint(`å·²å¡«å…… ${filled} é¡¹ã€‚`);
      }
    });

    replaceBtn?.addEventListener('click', ()=>{
      const txt = String(outTa?.value || '').trim();
      if(!txt){ toast('å†…å®¹ä¸ºç©º', 'è¯·å…ˆç²˜è´´ AI è¾“å‡ºã€‚', 'err'); return; }
      if(!summaryEl) return;
      summaryEl.value = txt;
      toast('å·²æ›¿æ¢æ‘˜è¦', 'å·²ç”¨å½“å‰æ–‡æœ¬æ›¿æ¢æ‘˜è¦ã€‚', 'ok');
      setHint('å·²æ›¿æ¢æ‘˜è¦ã€‚');
    });

    appendBtn?.addEventListener('click', ()=>{
      const txt = String(outTa?.value || '').trim();
      if(!txt){ toast('å†…å®¹ä¸ºç©º', 'è¯·å…ˆç²˜è´´ AI è¾“å‡ºã€‚', 'err'); return; }
      if(!summaryEl) return;
      const cur = String(summaryEl.value || '').trim();
      summaryEl.value = cur ? (cur + '\n\n' + txt) : txt;
      toast('å·²è¿½åŠ åˆ°æ‘˜è¦', 'å·²å°†æ–‡æœ¬è¿½åŠ åˆ°æ‘˜è¦æœ«å°¾ã€‚', 'ok');
      setHint('å·²è¿½åŠ ã€‚');
    });
  }

  // require login
  // Keep the full URL (including mode & preset board) for login redirect
  const next = encodeURIComponent('post-case.html' + location.search);
  await ensureAuthed(`login.html?next=${next}`);

  // AI tools are paused in this phase
  const ENABLE_AI_POST_TOOLS = false;
  if(ENABLE_AI_POST_TOOLS){
    mountAiPostTools();
  }else{
    try{ if(aiPostTools) aiPostTools.hidden = true; }catch(_e){}
  }

  // Doctor verification gate (Channel A: invite code)
  // Note: backend RLS also enforces this; UI here is to provide a clear path.
  let canPostCase = true;
  try{
    const sess = await getSession();
    const u = sess?.user;
    if(u){
      const prof = await getUserProfile(u);
      const r = normalizeRole(prof?.role || u.user_metadata?.role || 'member');

      // Board moderators (table) should be allowed to post even if not doctor-verified.
      let isBoardModerator = false;
      try{
        const rr = await supabase
          .from('board_moderators')
          .select('board_key')
          .eq('user_id', u.id)
          .limit(1);
        if(!rr.error){
          isBoardModerator = Array.isArray(rr.data) && rr.data.length > 0;
        }
      }catch(_e){
        // ignore (table may not exist yet)
        isBoardModerator = false;
      }

      const ok = Boolean(
        isAdminRole(r)
        || r === 'owner'
        || r === 'moderator'
        || r === 'doctor_verified'
        || r === 'doctor'
        || isBoardModerator
      );
      canPostCase = ok;
      if(!ok){
        const gate = document.getElementById('doctorGate');
        if(gate){
          gate.style.display = 'block';
          const back = encodeURIComponent('post-case.html' + location.search);
          gate.innerHTML = `<b>æç¤ºï¼š</b>å‘å¸ƒç—…ä¾‹ä¸ä¸Šä¼ é™„ä»¶éœ€è¦å®Œæˆ<b>åŒ»ç”Ÿè®¤è¯</b>ï¼ˆé‚€è¯·ç å¿«é€Ÿè®¤è¯æˆ–äººå·¥å®¡æ ¸ï¼‰ã€‚\
            <a class="btn tiny" href="verify-doctor.html?next=${back}">å»è®¤è¯</a>\
            <div class="small muted" style="margin-top:6px">\
              è®¤è¯é€šè¿‡åï¼Œä½ å³å¯å‘å¸ƒç—…ä¾‹å¹¶å‚ä¸ç—…ä¾‹è®¨è®ºã€‚\
            </div>`;
        }

        // Disable publish & attachment buttons (drafting is still allowed)
        const submitBtn = form?.querySelector('button[type="submit"]');
        if(submitBtn) submitBtn.disabled = true;
        const pickBtn = document.getElementById('casePostPickAttachBtn');
        if(pickBtn) pickBtn.disabled = true;
        const clearBtn = document.getElementById('casePostClearAttachBtn');
        if(clearBtn) clearBtn.disabled = true;
        const fileInput = document.getElementById('casePostAttachInput');
        if(fileInput) fileInput.disabled = true;
      }
    }
  }catch(_e){
    // Fail-open: do not block drafting. RLS will still block publishing if needed.
    canPostCase = true;
  }

  // Cache the current user once (avoid transient getSession glitches on submit)
  let currentUser = null;
  if(isConfigured() && supabase){
    try{
      const { data } = await supabase.auth.getSession();
      currentUser = data?.session?.user || null;
    }catch(_e){
      currentUser = null;
    }
  }

  async function ensureUser(){
    if(currentUser) return currentUser;
    if(!isConfigured() || !supabase) return null;
    try{
      const { data } = await supabase.auth.getSession();
      currentUser = data?.session?.user || null;
      return currentUser;
    }catch(_e){
      return null;
    }
  }

  // Load sections dynamically (optional). Falls back to 4 default options.
  async function loadSections(){
    if(!isConfigured() || !supabase) return;
    try{
      const { data, error } = await supabase
        .from('sections')
        .select('key, title_zh, status, sort, created_at')
        .eq('channel_id','case')
        .eq('status','active')
        .order('sort', { ascending: true })
        .order('created_at', { ascending: false });
      if(error) throw error;
      if(data && data.length){
        sectionSelect.innerHTML = data.map(s=>`<option value="${s.key}">${s.title_zh || s.key}</option>`).join('');
        if(sectionHint) sectionHint.textContent = 'åˆ†åŒºåˆ—è¡¨ç”±ç®¡ç†å‘˜ç»´æŠ¤ï¼›æ–°å¢/è°ƒæ•´åä¼šè‡ªåŠ¨åŒæ­¥ã€‚';
      }
    }catch(_e){
      // ignore (table may not exist yet)
    }
  }

  (async function initBoardPicker(){
    if(mode !== 'case') return;
    await loadSections();
    if(!presetBoard) return;
    try{
      const ok = Array.from(sectionSelect?.options || []).some(o => String(o.value) === presetBoard);
      if(ok && sectionSelect) sectionSelect.value = presetBoard;
    }catch(_e){}
  })();

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const fd = new FormData(form);
    const board = String(fd.get('board') || '');
    const title = String(fd.get('title') || '').trim();
    const summary = String(fd.get('summary') || '').trim();
	    const summary_html = (summary && summaryEditor) ? String(summaryEditor.getHtml() || '').trim() : '';
    const tags = String(fd.get('tags') || '')
      .split(',')
      .map(x=>x.trim())
      .filter(Boolean)
      .slice(0, 8);

    if(!title){
      toast('è¯·å¡«å†™æ ‡é¢˜', 'æ ‡é¢˜ä¸èƒ½ä¸ºç©ºã€‚', 'err');
      return;
    }
    if(!summary){
      toast('è¯·å¡«å†™æ‘˜è¦', 'å»ºè®® 200-600 å­—ï¼Œä¾¿äºè®¨è®ºã€‚', 'err');
      return;
    }

    // Doctor verification gate (UI). Backend RLS is the final enforcement.
    if(!canPostCase){
      toast('éœ€è¦åŒ»ç”Ÿè®¤è¯', 'å‘å¸ƒç—…ä¾‹ä¸ä¸Šä¼ é™„ä»¶éœ€è¦å®ŒæˆåŒ»ç”Ÿè®¤è¯ï¼ˆé‚€è¯·ç å¿«é€Ÿè®¤è¯æˆ–äººå·¥å®¡æ ¸ï¼‰ã€‚', 'err');
      return;
    }

    if(!isConfigured() || !supabase){
      toast('Supabase è¿˜æœªé…ç½®', 'è¯·å…ˆåœ¨ assets/config.js å¡«å…¥ SUPABASE_URL ä¸ SUPABASE_ANON_KEYã€‚', 'err');
      return;
    }

    const user = await ensureUser();
    if(!user){
      // IMPORTANT: do NOT auto-redirect. Some browsers may temporarily fail reading session.
      toast(
        'ç™»å½•æ€ä¸¢å¤±',
        'è¯·åˆ·æ–°é¡µé¢åé‡è¯•ï¼›è‹¥ä»ä¸è¡Œï¼Œè¯·æ¸…é™¤ kidneysphere.com çš„ç«™ç‚¹æ•°æ®ï¼ˆç¼“å­˜+å­˜å‚¨ï¼‰åé‡æ–°ç™»å½•ã€‚',
        'err'
      );
      return;
    }

	    const payload = {
      title,
      board,
      summary,
      summary_html: summary_html || null,
      tags,
      author_id: user.id,
      author_name: user.user_metadata?.full_name || user.phone || user.email || 'Member'
    };

	    // Disable submit during network operations
	    const submitBtn = form.querySelector('button[type="submit"]');
	    if(submitBtn) submitBtn.disabled = true;

	    const attachCount = attachPicks.length;

	    // Insert + readback (helps verify it truly landed)
	    const isMissingColumn = (err, col)=>{
	      const msg = String(err?.message || err || '').toLowerCase();
	      const c = String(col || '').toLowerCase();
	      return msg.includes(c) && (msg.includes('does not exist') || msg.includes('column') || msg.includes('schema cache'));
	    };

    let res = await supabase
      .from('cases')
      .insert(payload)
      .select('id, board')
      .single();

    if(res?.error && isMissingColumn(res.error, 'summary_html')){
      const retry = { ...payload };
      delete retry.summary_html;
      res = await supabase.from('cases').insert(retry).select('id, board').single();
    }

    const { data, error } = res || {};

	    if(error){
      toast(
        'å‘å¸ƒå¤±è´¥',
        'è¯·æ£€æŸ¥ Supabase æ˜¯å¦å·²å»ºè¡¨ casesï¼Œå¹¶è®¾ç½®å¥½ RLSã€‚é”™è¯¯ï¼š' + (error.message || 'Unknown error'),
        'err'
      );
	      if(submitBtn) submitBtn.disabled = false;
	      return;
    }

	    // Upload attachments for the case (optional)
	    if(data?.id && attachCount){
	      const caseId = Number(data.id);
	      const authorName = payload.author_name;
	      try{
	        const total = attachPicks.length;
	        for(let i=0;i<total;i++){
	          const f = attachPicks[i]?.file;
	          if(!f) continue;
	          const kind = guessKindFromMime(f.type, f.name);
	          const rid = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `${Date.now()}_${Math.random().toString(16).slice(2)}`;
	          const key = `${user.id}/case/${caseId}/${rid}_${safeFilename(f.name)}`;

	          const up = await supabase
	            .storage
	            .from('attachments')
	            .upload(key, f, { upsert:false, contentType: f.type || undefined, cacheControl: '3600' });
	          if(up?.error) throw up.error;

	          const url = null; // attachments bucket is private; resolve via signed URLs when rendering

	          const ares = await supabase
	            .from('attachments')
	            .insert({
	              target_type: 'case',
	              target_id: Number(caseId),
	              author_id: user.id,
	              author_name: authorName,
	              bucket: 'attachments',
	              path: key,
	              public_url: url,
	              mime_type: f.type || null,
	              original_name: f.name || null,
	              size_bytes: f.size || null,
	              kind,
	              deleted_at: null,
	            });
	          if(ares?.error){
	            const msg = String(ares.error.message || ares.error);
	            if(/relation .*attachments.* does not exist|does not exist|PGRST/i.test(msg)){
	              throw new Error('é™„ä»¶åŠŸèƒ½æœªåˆå§‹åŒ–ï¼šè¯·åœ¨ Supabase SQL Editor è¿è¡Œæœ€æ–°ç‰ˆ SUPABASE_SETUP.sqlï¼ˆåŒ…å« attachments è¡¨ä¸ Storage bucketï¼‰ï¼Œç„¶ååˆ° Settings â†’ API ç‚¹å‡» Reload schemaã€‚');
	            }
	            throw ares.error;
	          }
	        }
	      }catch(attErr){
	        toast('é™„ä»¶ä¸Šä¼ å¤±è´¥', attErr.message || String(attErr), 'err');
	      }
	    }

	    clearAttachDraft();

	    toast('å‘å¸ƒæˆåŠŸ', `å·²å†™å…¥æ•°æ®åº“ï¼ˆID: ${data?.id || '-'}ï¼‰${attachCount ? `ï¼Œé™„ä»¶ï¼š${attachCount} ä¸ª` : ''}ï¼Œæ­£åœ¨è·³è½¬â€¦`, 'ok');
	    setTimeout(()=> location.href = `case.html?id=${encodeURIComponent(data?.id || '')}`, 700);
  });
</script>

  </main>

  <footer class="footer" data-blurb="ä»¥ç—…ä¾‹è®¨è®ºä¸å­¦ä¹ ä½“ç³»ä¸ºæ ¸å¿ƒï¼Œé€æ­¥å»ºè®¾å¯æ²‰æ·€ã€å¯æ£€ç´¢çš„è‚¾è„ç—…çŸ¥è¯†ç¤¾åŒºã€‚"></footer>
<script type="module" src="app.js?v=20260128_030"></script>
</body>
</html>
