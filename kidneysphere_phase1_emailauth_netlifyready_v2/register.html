<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>邮箱注册 · KidneySphere</title>
  <meta name="description" content="KidneySphere × KidneySphere AI">
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html" aria-label="KidneySphere Home">
        <img src="assets/logo.png" alt="KidneySphere AI Logo" />
        <div class="title">
          <b>肾域AI · KidneySphere</b>
          <span>GlomCon China × KidneySphere AI</span>
        </div>
      </a>

      <nav class="menu" aria-label="Primary">
        <a data-nav href="index.html">首页 <span class="en">Home</span></a>
        <a data-nav href="community.html">社区讨论 <span class="en">Community</span></a>
        <a data-nav href="learning.html">学习中心 <span class="en">Learning</span></a>
        <a data-nav href="frontier.html">前沿进展 <span class="en">Frontier</span></a>
        <a data-nav href="events.html">会议/事件 <span class="en">Events</span></a>
        <a data-nav href="about.html">关于 <span class="en">About</span></a>
      </nav>

      <div class="auth" data-auth>
        <a class="btn" href="login.html">登录</a>
        <a class="btn primary" href="register.html">注册</a>
      </div>
    </div>
  </header>

  <main>

<section class="hero">
  <div class="container">
    <div class="card" style="max-width:820px;margin:0 auto">
      <h2>邮箱注册</h2>
      <p>使用 <b>邮箱 + 密码</b> 注册并登录。建议填写昵称与身份，便于病例讨论署名与后续运营。</p>

      <div class="note" style="margin:12px 0 6px">
        <b>提示：</b>测试阶段建议在 Supabase 关闭 <b>Confirm Email</b>（注册不需要发确认邮件）。如果你开启了 Confirm Email，注册后需要先去邮箱完成确认，再回到本站登录。
      </div>

      <form id="registerForm">
        <div class="form-row">
          <div>
            <label>姓名 / 昵称</label>
            <input class="input" name="full_name" id="nameInput" placeholder="例如：刘松" required />
          </div>
          <div>
            <label>身份（可选）</label>
            <select class="input" name="role" id="roleInput">
              <option value="Member">会员</option>
              <option value="Doctor">医生（待审核）</option>
              <option value="Industry">企业/赞助方</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>邮箱</label>
            <input class="input" name="email" id="emailInput" type="email" placeholder="name@example.com" autocomplete="email" inputmode="email" required />
          </div>
          <div>
            <label>密码（至少 6 位）</label>
            <input class="input" name="password" id="passwordInput" type="password" placeholder="设置密码" autocomplete="new-password" required />
          </div>
        </div>

        <label>确认密码</label>
        <input class="input" name="password2" id="password2Input" type="password" placeholder="再次输入密码" autocomplete="new-password" required />

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
          <button class="btn primary" type="submit">注册</button>
          <a class="btn" href="login.html">我已有账号，去登录</a>
          <a class="btn" href="index.html">返回首页</a>
        </div>

        <div class="small muted" style="margin-top:10px">
          如果你启用了 Confirm Email，需要在 Supabase <b>URL Configuration</b> 中把站点地址设置为 Netlify 域名，并把 <code>/auth-callback.html</code> 加入允许的 Redirect URLs（否则确认后会跳到 localhost）。
        </div>
      </form>

      <div id="confirmWrap" class="note" style="margin-top:14px" hidden>
        <b>下一步：</b>
        <div class="small" style="margin-top:6px">
          我们已尝试发送确认邮件到 <code id="confirmEmail"></code>。请打开邮箱完成确认，然后再回到本站 <a href="login.html">登录</a>。
        </div>
      </div>

    </div>
  </div>
</section>

<script type="module">
  import { supabase, toast, isConfigured } from './supabaseClient.js';

  const qs = new URLSearchParams(location.search);
  const nextRaw = qs.get('next') || '';
  const next = (nextRaw && !nextRaw.startsWith('http') && !nextRaw.startsWith('//') && !nextRaw.includes('..'))
    ? nextRaw
    : 'post-case.html';

  const form = document.getElementById('registerForm');
  const nameInput = document.getElementById('nameInput');
  const roleInput = document.getElementById('roleInput');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const password2Input = document.getElementById('password2Input');

  const confirmWrap = document.getElementById('confirmWrap');
  const confirmEmail = document.getElementById('confirmEmail');

  function getEmailRedirectTo(){
    const url = new URL('auth-callback.html', location.origin);
    url.searchParams.set('next', next);
    return url.toString();
  }

  async function syncProfile(user, full_name, role){
    try{
      await supabase
        .from('profiles')
        .upsert({ id: user.id, full_name: full_name || null, role: role || null }, { onConflict: 'id' });
    }catch(_e){ /* profiles 表可能尚未创建，忽略 */ }
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    if(!isConfigured() || !supabase){
      toast('Supabase 还未配置','请先在 assets/config.js 填入 SUPABASE_URL 与 SUPABASE_ANON_KEY。','err');
      return;
    }

    const full_name = String(nameInput.value || '').trim();
    const role = String(roleInput.value || 'Member');
    const email = String(emailInput.value || '').trim().toLowerCase();
    const password = String(passwordInput.value || '');
    const password2 = String(password2Input.value || '');

    if(!full_name){
      toast('请填写昵称','用于病例讨论署名展示（后续可修改）。','err');
      return;
    }
    if(!email || !email.includes('@')){
      toast('邮箱格式不正确','请填写有效邮箱地址。','err');
      return;
    }
    if(password.length < 6){
      toast('密码太短','请设置至少 6 位的密码。','err');
      return;
    }
    if(password !== password2){
      toast('两次密码不一致','请重新确认密码。','err');
      return;
    }

    const emailRedirectTo = getEmailRedirectTo();

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo,
        data: { full_name, role },
      }
    });

    if(error){
      toast('注册失败', error.message || '未知错误', 'err');
      return;
    }

    const user = data?.session?.user;
    if(data?.session && user){
      await syncProfile(user, full_name, role);
      toast('注册成功','已自动登录，正在跳转…','ok');
      setTimeout(()=> location.href = next, 700);
      return;
    }

    confirmEmail.textContent = email;
    confirmWrap.hidden = false;
    toast('注册成功','请前往邮箱完成确认，然后再登录。', 'ok');
  });
</script>

  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <img src="assets/logo.png" alt="logo" style="width:26px;height:26px;border-radius:8px">
          <b>KidneySphere × KidneySphere AI</b>
        </div>
        <div class="small">Phase 1 Stable · 以“邮箱注册/登录 + 可发布病例 + 学习中心/前沿进展”为核心，优先上线测试。</div>
      </div>
      <div class="small">
        <div>© 2025 KidneySphere</div>
        <div style="margin-top:8px">联系：<a href="mailto:china@glomcon.org">china@glomcon.org</a></div>
      </div>
    </div>
  </footer>

  <div class="toast" data-toast></div>
  <script type="module" src="app.js"></script>
</body>
</html>
