<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>重置密码 · KidneySphere</title>
  <meta name="description" content="KidneySphere × KidneySphere AI">
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=20260213_001" />
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html" aria-label="KidneySphere Home">
        <img src="assets/logo.png" alt="KidneySphere AI Logo" />
        <div class="title">
          <b>肾域AI · KidneySphereAI</b>
          <span>GlomCon中国 × KidneySphere AI</span>
        </div>
      </a>

      <nav class="menu" aria-label="Primary">
        <a data-nav href="index.html"><span class="zh">首页</span><span class="en">Home</span></a>
        <a data-nav href="community.html"><span class="zh">社区讨论</span><span class="en">Community</span></a>
        <a data-nav href="learning.html"><span class="zh">学习中心</span><span class="en">Learning</span></a>
        <a data-nav href="frontier.html"><span class="zh">前沿进展</span><span class="en">Frontier</span></a>
        <a data-nav href="moments.html"><span class="zh">社区动态</span><span class="en">Moments</span></a>
        <a data-nav href="events.html"><span class="zh">会议与活动</span><span class="en">Events</span></a>
        <a data-nav href="research.html"><span class="zh">临床研究中心</span><span class="en">Research</span></a>
        <a data-nav href="about.html"><span class="zh">关于</span><span class="en">About</span></a>
      </nav>

      <div class="auth" data-auth>
        <a class="btn" href="login.html">登录</a>
        <a class="btn primary" href="register.html">注册</a>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <div class="card" style="max-width:820px;margin:0 auto">
          <h2>重置密码</h2>
          <p>
            请设置一个新密码。为安全起见：至少 <b>8</b> 位，需包含 <b>字母</b> 与 <b>数字</b>；建议再加入大写字母与特殊符号。
          </p>

          <div class="note" style="margin:12px 0 14px">
            <b>说明：</b>请在下方设置一个新的密码。
            <span style="opacity:.9">最低要求：至少 8 位且包含字母与数字；</span>
            <span style="opacity:.9">更安全：再包含大写字母与特殊符号。</span>
            若链接已过期或已使用，请返回“忘记密码”重新发送。
          </div>

          <div id="status" class="small"></div>

          <div id="resetWrap" hidden>
            <form id="resetForm">
              <label>新密码（至少 8 位，需包含字母+数字）</label>
              <input class="input" id="passwordInput" type="password" placeholder="设置新密码" autocomplete="new-password" required />

              <label style="margin-top:12px">确认新密码</label>
              <input class="input" id="password2Input" type="password" placeholder="再次输入新密码" autocomplete="new-password" required />

              <div class="small" style="display:flex;align-items:center;gap:8px;margin-top:10px">
                <input id="showPw" type="checkbox" style="width:16px;height:16px">
                <label for="showPw" style="margin:0;color:rgba(233,241,255,.78)">显示密码</label>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px">
                <button class="btn primary" type="submit">更新密码</button>
                <a class="btn" href="login.html">返回登录</a>
                <a class="btn" href="index.html">返回首页</a>
              </div>
            </form>
          </div>

        </div>
      </div>
    </section>

    <script type="module">
    import { supabase, ensureSupabase, isConfigured, toast } from './supabaseClient.js?v=20260128_030';

      const statusEl = document.getElementById('status');
      const wrap = document.getElementById('resetWrap');
      const form = document.getElementById('resetForm');
      const pw1 = document.getElementById('passwordInput');
      const pw2 = document.getElementById('password2Input');
      const showPw = document.getElementById('showPw');
      const submitBtn = form.querySelector('button[type="submit"]');

      // Supabase client is lazily initialised. Do NOT rely on the exported `supabase` value
      // being ready on first load (it may be null until ensureSupabase() runs).
      let sb = null;

      const qs = new URLSearchParams(location.search);
      const nextRaw = qs.get('next') || '';
      const next = (nextRaw && !nextRaw.startsWith('http') && !nextRaw.startsWith('//') && !nextRaw.includes('..'))
        ? nextRaw
        : 'index.html';

      function esc(s){
        return String(s ?? '').replace(/[&<>"']/g, ch => ({
          '&':'&amp;',
          '<':'&lt;',
          '>':'&gt;',
          '"':'&quot;',
          "'":'&#39;'
        }[ch]));
      }

      function setStatus(html){ statusEl.innerHTML = html; }

      showPw?.addEventListener('change', ()=>{
        const t = showPw.checked ? 'text' : 'password';
        pw1.type = t;
        pw2.type = t;
      });

      async function ensureRecoverySession(){
        if(!isConfigured()){
          // Do not expose deployment details to end users.
          setStatus('<div class="muted">系统配置异常，请联系管理员。</div>');
          return false;
        }

        try{
          // Ensure the Supabase client is initialised on this page.
          // (On some pages, the exported `supabase` value may still be null until ensureSupabase runs.)
          sb = await ensureSupabase();
        }catch(e){
          console.error(e);
          setStatus('<div class="muted">系统暂时无法连接认证服务，请稍后再试或联系管理员。</div>');
          return false;
        }

        setStatus('<div class="muted">正在校验重置链接…</div>');

        const url = new URL(location.href);
	      const code = url.searchParams.get('code');
        const err = url.searchParams.get('error');
        const errDesc = url.searchParams.get('error_description');

	      const hashParams = new URLSearchParams(location.hash.startsWith('#') ? location.hash.slice(1) : location.hash);
	      const access_token = hashParams.get('access_token') || url.searchParams.get('access_token');
	      const refresh_token = hashParams.get('refresh_token') || url.searchParams.get('refresh_token');
	      // 新版 Supabase 可能会给 token_hash（email link/恢复链接）
	      const token_hash = url.searchParams.get('token_hash') || hashParams.get('token_hash');
	      // 兼容极少数场景：token + email
	      const token = url.searchParams.get('token') || hashParams.get('token');
	      const emailParam = url.searchParams.get('email') || hashParams.get('email');
	      const type = String(url.searchParams.get('type') || hashParams.get('type') || '').toLowerCase();

        // If the page is opened without a real recovery token, do NOT fall back to the
        // currently logged-in session. Otherwise, users may feel "I reset account B but
        // it opened account A" (because A was already logged in), and worst case they
        // could reset the wrong password.
	      const hasToken = Boolean(code || token_hash || (token && emailParam) || (access_token && refresh_token));
        const isRecovery = (type === 'recovery') || hasToken;
        if(!isRecovery || !hasToken){
          setStatus('<div class="muted">此页面仅用于“邮箱重置密码”邮件里的链接。请回到邮箱点击最新的重置链接进入。<br><span class="small">若你是直接打开了 reset.html 或从收藏夹进入，这里不会生效。</span></div>');
          return false;
        }

        if(err){
          setStatus(`<div class="muted">链接异常：<b>${esc(err)}</b><br>${esc(errDesc || '')}</div>`);
          return false;
        }

        try{
          // If you are currently logged in (often the "main" account) AND you are opening
          // a recovery link for another account, clear the existing session first so the
          // recovery session can become the source of truth.
          try{
            const { data: { session: existing } } = await sb.auth.getSession();
            if(existing){
              // 仅清理本地会话，避免对恢复流程产生额外影响
              await sb.auth.signOut({ scope: 'local' });
            }
          }catch(_e){ /* ignore */ }

	          const otpType = (type || 'recovery');

	          if(code){
            setStatus('<div class="muted">正在交换 code 获取 session…</div>');
            const { error } = await sb.auth.exchangeCodeForSession(code);
            if(error){
              setStatus(`<div class="muted">交换 code 失败：${esc(error.message)}</div>`);
              return false;
            }
            url.searchParams.delete('code');
            history.replaceState({}, '', url.pathname + (url.search || ''));
	          } else if(token_hash){
	            // Newer links may contain token_hash (email OTP style)
	            setStatus('<div class="muted">正在验证重置链接…</div>');
	            try{
	              const { error } = await sb.auth.verifyOtp({ type: otpType, token_hash });
	              if(error){
	                setStatus(`<div class="muted">验证失败：${esc(error.message)}</div>`);
	                return false;
	              }
	            }catch(e){
	              setStatus(`<div class="muted">验证失败：${esc(e?.message || e)}</div>`);
	              return false;
	            }
	            // 清理 URL（避免 token_hash 暴露在地址栏/历史记录）
	            try{
	              url.searchParams.delete('token_hash');
	              history.replaceState({}, '', url.pathname + (url.search || ''));
	            }catch(_e){}
	          } else if(token && emailParam){
	            // Legacy token + email flow
	            setStatus('<div class="muted">正在验证重置链接…</div>');
	            try{
	              const { error } = await sb.auth.verifyOtp({ type: otpType, token, email: emailParam });
	              if(error){
	                setStatus(`<div class="muted">验证失败：${esc(error.message)}</div>`);
	                return false;
	              }
	            }catch(e){
	              setStatus(`<div class="muted">验证失败：${esc(e?.message || e)}</div>`);
	              return false;
	            }
	            try{
	              url.searchParams.delete('token');
	              history.replaceState({}, '', url.pathname + (url.search || ''));
	            }catch(_e){}
	          } else if(access_token && refresh_token){
	            setStatus('<div class="muted">正在写入 session…</div>');
	            const { error } = await sb.auth.setSession({ access_token, refresh_token });
	            if(error){
	              setStatus(`<div class="muted">写入 session 失败：${esc(error.message)}</div>`);
	              return false;
	            }
	            history.replaceState({}, '', url.pathname + (url.search || ''));
	          }

          const { data: { session } } = await sb.auth.getSession();
	          if(!session){
	            setStatus('<div class="muted">未获取到 session。请重新打开邮件里的重置链接，或回到登录页重新发送重置邮件。若持续失败，请联系管理员协助排查。</div>');
	            return false;
	          }
          // Show which account is being recovered (avoid confusion)
          const email = session?.user?.email || '';
          if(email){
            setStatus('<div class="muted">已验证重置链接：<b>'+esc(email)+'</b>（请设置新密码）</div>');
          }
          return true;
        }catch(e){
          setStatus(`<div class="muted">处理重置链接失败：${esc(e?.message || e)}</div>`);
          return false;
        }
      }

      async function run(){
        const ok = await ensureRecoverySession();
        if(!ok) return;
        // status 已在 ensureRecoverySession 中写入（包含邮箱）
        wrap.hidden = false;
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();

        submitBtn.disabled = true;
        const oldText = submitBtn.textContent;
        submitBtn.textContent = '更新中…';

        const p1 = String(pw1.value || '');
        const p2 = String(pw2.value || '');
        // 密码策略（前端校验）：至少 8 位，且包含字母 + 数字
        const hasLetter = /[A-Za-z]/.test(p1);
        const hasNumber = /\d/.test(p1);
        const hasSpace = /\s/.test(p1);

        if(p1.length < 8){
          toast('密码太短','请设置至少 8 位的新密码。', 'err');
          submitBtn.disabled = false;
          submitBtn.textContent = oldText;
          return;
        }
        if(hasSpace){
          toast('密码格式不正确','密码中请不要包含空格。', 'err');
          submitBtn.disabled = false;
          submitBtn.textContent = oldText;
          return;
        }
        if(!hasLetter || !hasNumber){
          toast('密码强度不足','请至少同时包含字母和数字。建议加入大写字母与特殊符号以提高安全性。', 'err');
          submitBtn.disabled = false;
          submitBtn.textContent = oldText;
          return;
        }
        if(p1 !== p2){
          toast('两次密码不一致','请重新确认。', 'err');
          submitBtn.disabled = false;
          submitBtn.textContent = oldText;
          return;
        }

        // Ensure client is ready even if the page loaded before Supabase finished initialising.
        const client = sb || supabase || await ensureSupabase();
        const { error } = await client.auth.updateUser({ password: p1 });
        if(error){
          toast('更新失败', error.message || '未知错误', 'err');
          submitBtn.disabled = false;
          submitBtn.textContent = oldText;
          return;
        }

        // Best practice: sign out the temporary recovery session.
        try{ await (sb || supabase || client).auth.signOut({ scope: 'local' }); }catch(_e){}

        toast('已更新', '密码已更新，请用新密码重新登录。', 'ok');
        setStatus('<div class="muted">密码已更新，即将跳转到登录页…</div>');
        setTimeout(()=>{ location.href = 'login.html?reset=1'; }, 900);
      });

      run();
    </script>
  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <img src="assets/logo.png" alt="logo" style="width:26px;height:26px;border-radius:8px">
          <b>KidneySphere × KidneySphere AI</b>
        </div>
        <div class="small">重置密码</div>
      </div>
      <div class="small">
        <div>© 2025 KidneySphere</div>
        <div style="margin-top:8px">联系：<a href="mailto:china@glomcon.org">china@glomcon.org</a></div>
      </div>
    </div>
  </footer>

  <div class="toast" data-toast></div>
  <script type="module" src="app.js?v=20260128_030"></script>
</body>
</html>
