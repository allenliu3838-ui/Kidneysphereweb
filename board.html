<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¤¾åŒºæ¿å— Â· KidneySphere</title>
  <meta name="description" content="KidneySphere Ã— KidneySphere AI">
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=20260213_001" />
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html" aria-label="KidneySphere Home">
        <img src="assets/logo.png" alt="KidneySphere AI Logo" />
        <div class="title">
          <b>è‚¾åŸŸAI Â· KidneySphereAI</b>
          <span>GlomConä¸­å›½ Ã— KidneySphere AI</span>
        </div>
      </a>

      <nav class="menu" aria-label="Primary">
        <a data-nav href="index.html"><span class="zh">é¦–é¡µ</span><span class="en">Home</span></a>
        <a data-nav href="community.html"><span class="zh">ç¤¾åŒºè®¨è®º</span><span class="en">Community</span></a>
        <a data-nav href="learning.html"><span class="zh">å­¦ä¹ ä¸­å¿ƒ</span><span class="en">Learning</span></a>
        <a data-nav href="frontier.html"><span class="zh">å‰æ²¿è¿›å±•</span><span class="en">Frontier</span></a>
        <a data-nav href="moments.html"><span class="zh">ç¤¾åŒºåŠ¨æ€</span><span class="en">Moments</span></a>
        <a data-nav href="events.html"><span class="zh">ä¼šè®®ä¸æ´»åŠ¨</span><span class="en">Events</span></a>
        <a data-nav href="research.html"><span class="zh">ä¸´åºŠç ”ç©¶ä¸­å¿ƒ</span><span class="en">Research</span></a>
        <a data-nav href="about.html"><span class="zh">å…³äº</span><span class="en">About</span></a>
      </nav>

      <div class="auth" data-auth>
        <a class="btn" href="login.html">ç™»å½•</a>
        <a class="btn primary" href="register.html">æ³¨å†Œ</a>
      </div>
    </div>
  </header>

  <main>
    
<section class="hero">
  <div class="container">
    <div class="card">
      <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>
          <span class="badge">ç—…ä¾‹æ¿å—</span>
          <h2 id="boardTitle" style="margin-top:10px">æ¿å—</h2>
          <p id="boardDesc">åŠ è½½ä¸­â€¦</p>
          <div id="boardModerators" class="small muted" style="margin-top:10px" hidden></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn primary" href="#" id="btnNew">+ å‘å¸ƒç—…ä¾‹</a>
          <a class="btn" href="community.html">è¿”å›ç¤¾åŒº</a>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid cols-2" id="caseList">
        <!-- cards injected -->
      </div>

      <div class="hr"></div>
      </div>
  </div>
</section>

<script type="module">
  import { supabase, isConfigured, toast, ensureSupabase, getCurrentUser, formatBeijingDateTime } from './supabaseClient.js?v=20260128_030';

  const qs = new URLSearchParams(location.search);
  const highlightId = (qs.get('highlight') || '').toString();
  // Backward compatible param: b=glom. Future-friendly: c=case&s=glom
  const sectionKey = (qs.get('s') || qs.get('b') || 'glom').toString();
  const channel = (qs.get('c') || 'case').toString().toLowerCase();
  const isCaseChannel = channel === 'case';
  const boardKey = isCaseChannel ? sectionKey : channel; // research / literature

  const titleEl = document.getElementById('boardTitle');
  const descEl = document.getElementById('boardDesc');
  const list = document.getElementById('caseList');
  const modsEl = document.getElementById('boardModerators');

  let boardModerators = [];
  let moderatorIds = new Set();

  // å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆæœªå£°æ˜ä¼šå¯¼è‡´æ¨¡å—è„šæœ¬ç›´æ¥æŠ¥é”™ï¼Œç—…ä¾‹åˆ—è¡¨æ— æ³•åŠ è½½ï¼‰
  let currentUser = null;

  const SECTION_MAP = {
    glom: { t: 'è‚¾å°çƒä¸é—´è´¨æ€§è‚¾ç—…ç¤¾åŒº', d:'IgANã€MNã€FSGSã€MCDã€AAVã€è¡¥ä½“ç›¸å…³ç—…ã€é—´è´¨æ€§è‚¾ç‚/è¯ç‰©ç›¸å…³è‚¾æŸä¼¤ç­‰' },
    tx:   { t: 'è‚¾ç§»æ¤å†…ç§‘ç¤¾åŒº', d:'æ’æ–¥ã€æ„ŸæŸ“ã€å…ç–«æŠ‘åˆ¶ã€å¦Šå¨ ã€éšè®¿ç®¡ç†' },
    icu:  { t: 'é‡ç—‡è‚¾å†…ï¼ˆç”µè§£è´¨/é…¸ç¢±ï¼‰ä¸é€æç¤¾åŒº', d:'AKI/CRRTã€ä¼‘å…‹ã€æ¶²ä½“/æŠ—å‡ã€ç”µè§£è´¨/é…¸ç¢±ç´Šä¹±ã€é€æå¹¶å‘ç—‡' },
    peds: { t: 'å„¿ç«¥è‚¾è„ç—…ç¤¾åŒº', d:'å„¿è‚¾ç—…ä¾‹ã€é—ä¼ è‚¾ç—…ã€å„¿ç«¥é€æä¸ç§»æ¤éšè®¿' },
    rare: { t: 'ç½•è§è‚¾è„ç—…ç¤¾åŒº', d:'é—ä¼ /ç½•è§è‚¾ç—…ã€C3G/aHUSã€MGRSã€Fabry ç­‰' },
  };

  const CHANNEL_META = {
    research: { t: 'ç§‘ç ”è®¨è®º', d: 'ä¸´åºŠ + åŸºç¡€ç ”ç©¶çš„æƒ³æ³•ç¢°æ’ã€æ–¹æ¡ˆè®¨è®ºã€æ•°æ®è§£è¯»ï¼›æ”¯æŒé™„ä»¶ä¸é•¿æ–‡ã€‚' },
    literature: { t: 'æ–‡çŒ®å­¦ä¹ ï¼ˆJournal Clubï¼‰', d: 'æŒ‡å—/ç»¼è¿°/ä¸´åºŠè¯•éªŒ/æ–°è¯æœºåˆ¶ï¼šå¯å‘å¸–ã€å¯ä¸Šä¼  PDF/å›¾ç‰‡ï¼Œæ”¯æŒè®¨è®ºä¸æ”¶è—ã€‚' },
    english: { t: 'å›½é™…è®¨è®ºä¸“åŒºï¼ˆè‹±è¯­ï¼‰', d: 'å³å°†å¼€æ”¾ï¼šé¢å‘å›½é™…åä½œä¸å­¦æœ¯æ²Ÿé€šçš„è‹±è¯­è®¨è®ºä¸“åŒºã€‚' },
  };

  const fallback = isCaseChannel
    ? (SECTION_MAP[sectionKey] || { t: sectionKey, d: 'ç—…ä¾‹è®¨è®ºåˆ†åŒº' })
    : (CHANNEL_META[channel] || { t: channel, d: 'è®¨è®ºæ¿å—' });
  titleEl.textContent = fallback.t;
  descEl.textContent = fallback.d;

  async function loadMeta(){
    if(!isConfigured() || !supabase) return;
    try{
      if(isCaseChannel){
        const { data, error } = await supabase
          .from('sections')
          .select('title_zh, description')
          .eq('channel_id','case')
          .eq('key', sectionKey)
          .maybeSingle();
        if(!error && data){
          titleEl.textContent = data.title_zh || fallback.t;
          descEl.textContent = data.description || fallback.d;
        }
      }else{
        // Optional: if channels table exists, prefer DB copy
        const { data, error } = await supabase
          .from('channels')
          .select('title_zh, description')
          .eq('id', channel)
          .maybeSingle();
        if(!error && data){
          titleEl.textContent = data.title_zh || fallback.t;
          descEl.textContent = data.description || fallback.d;
        }
      }
    }catch(_e){
      // table may not exist yet
    }
  }


  function renderModerators(){
    if(!modsEl) return;
    if(!boardModerators || boardModerators.length === 0){
      modsEl.hidden = true;
      modsEl.innerHTML = '';
      return;
    }
    modsEl.hidden = false;
    const chips = boardModerators.map(m => {
      const name = escapeHtml((m && m.display_name) ? m.display_name : 'ç‰ˆä¸»');
      return `<span class=\"badge mod mini\">ğŸ›¡ï¸ ${name}</span>`;
    }).join(' ');
    modsEl.innerHTML = `<b>æ¿å—ç‰ˆä¸»ï¼š</b> ${chips}`;
  }

  async function loadModerators(){
    // not configured / not initialized
    if(!isConfigured() || !supabase) { renderModerators(); return; }
    try{
      const { data, error } = await supabase
        .from('board_moderators')
        .select('user_id, display_name, avatar_url, created_at')
        .eq('board_key', boardKey)
        .order('created_at', { ascending: true });
      if(error) throw error;
      boardModerators = data || [];
      moderatorIds = new Set((boardModerators || []).map(x => x.user_id));
      renderModerators();
    }catch(e){
      const msg = String(e && e.message ? e.message : e || '');
      // table not created yet
      if(/board_moderators/i.test(msg) && /(does not exist|relation|schema cache|not find|could not find)/i.test(msg)){
        boardModerators = [];
        moderatorIds = new Set();
        renderModerators();
        return;
      }
      // non-fatal
      boardModerators = [];
      moderatorIds = new Set();
      renderModerators();
    }
  }

  function card(item, faved=false){
    const tags = (item.tags || []).map(x=>`<span class="badge" style="border-color:rgba(255,255,255,.14);background:rgba(255,255,255,.06)">${escapeHtml(x)}</span>`).join(' ');
    const when = item.created_at ? formatBeijingDateTime(item.created_at) : '';
    const likes = Math.max(0, Number(item.like_count || 0));
    const isMod = !!(moderatorIds && moderatorIds.has(item.author_id));
    const modBadge = isMod ? ' <span class=\"badge mod mini\">ç‰ˆä¸»</span>' : '';
    const isHighlight = !!highlightId && String(item.id) === String(highlightId);
    const hlStyle = isHighlight ? 'style=\"border-color: rgba(59,130,246,.65); box-shadow: 0 0 0 4px rgba(59,130,246,.12)\"' : '';
    return `
      <a class="card soft card-link" id="case-${item.id}" ${hlStyle} href="case.html?id=${item.id}">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div style="min-width:0">
            <h3 style="margin:0 0 6px">${escapeHtml(item.title)}</h3>
            <p style="margin:0 0 8px">${escapeHtml(item.summary || '')}</p>
            <div class="small">ä½œè€…ï¼š${escapeHtml(item.author_name || 'åŒ¿å')}${modBadge} Â· ${when} Â· ğŸ‘ ${likes}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">${tags}</div>
          </div>
          <div class="small muted" style="white-space:nowrap;margin-top:2px">æŸ¥çœ‹</div>
        </div>
      </a>
    `;
  }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function maybeScrollHighlight(){
    if(!highlightId) return;
    const el = document.getElementById(`case-${highlightId}`);
    if(!el) return;
    setTimeout(()=>{
      try{ el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }catch(_e){}
    }, 80);
  }

  async function load(){
    if(isConfigured()){
      // IMPORTANT: supabaseClient.js ä¸ä¼šè‡ªåŠ¨åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼›å¿…é¡»å…ˆ ensureSupabase()
      await ensureSupabase();
      if(!supabase){
        list.innerHTML = `<div class="note">æœåŠ¡åˆå§‹åŒ–å¤±è´¥ï¼ˆå¯èƒ½ç½‘ç»œæ‹¦æˆªæˆ–é…ç½®é”™è¯¯ï¼‰ã€‚è¯·åˆ·æ–°é‡è¯•ï¼›å¦‚ä»å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚</div>`;
        return;
      }
      try{
        currentUser = await getCurrentUser();
      }catch(_e){ currentUser = null; }
      // load moderators for this board (badge + header)
      await loadModerators();
    }

    // Open channels: case / research / literature
    // English (international) remains coming soon.
    if(!['case','research','literature'].includes(channel)){
      const meta = CHANNEL_META[channel] || { t: 'è¯¥æ¿å—', d: '' };
      list.innerHTML = `<div class="note"><b>${escapeHtml(meta.t || 'è¯¥æ¿å—')}</b> æš‚æœªå¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…ã€‚${meta.d ? ` ${escapeHtml(meta.d)}` : ''}</div>`;
      return;
    }

    // demo mode
    if(!isConfigured()){
      const demo = {
        case: [
          {title:'ï¼ˆæ¼”ç¤ºï¼‰IgAN æ–°è¯ï¼šsparsentan / iptacopan çš„ä¸´åºŠè¦ç‚¹', summary:'è¿™æ˜¯æ¼”ç¤ºæ•°æ®ã€‚é…ç½®å®Œæˆåå°†ä»æ•°æ®åº“è¯»å–ã€‚', tags:['IgAN','æ–°è¯'], created_at: Date.now(), author_name:'KidneySphere'},
          {title:'ï¼ˆæ¼”ç¤ºï¼‰ç§»æ¤åTMAç—…ä¾‹ï¼šè¡¥ä½“ä¸æ²»ç–—è·¯å¾„', summary:'è¿™æ˜¯æ¼”ç¤ºæ•°æ®ã€‚', tags:['ç§»æ¤','TMA'], created_at: Date.now()-3600*1000*6, author_name:'KidneySphere'},
        ],
        literature: [
          {title:'ï¼ˆæ¼”ç¤ºï¼‰KDIGO 2024 Updateï¼šå…³é”®å˜æ›´ä¸ä¸´åºŠè½åœ°', summary:'è¿™æ˜¯æ¼”ç¤ºæ•°æ®ï¼šå¯ä¸Šä¼ PDF/å›¾ç‰‡å¹¶è®¨è®ºã€‚', tags:['æŒ‡å—','KDIGO'], created_at: Date.now(), author_name:'KidneySphere'},
        ],
        research: [
          {title:'ï¼ˆæ¼”ç¤ºï¼‰ç ”ç©¶æƒ³æ³•ï¼šIgAN çœŸå®ä¸–ç•Œé˜Ÿåˆ—ä¸ç»“å±€æŒ‡æ ‡', summary:'è¿™æ˜¯æ¼”ç¤ºæ•°æ®ï¼šæ¬¢è¿è®¨è®ºç ”ç©¶è®¾è®¡/ç»Ÿè®¡æ–¹æ¡ˆã€‚', tags:['ç ”ç©¶è®¾è®¡','é˜Ÿåˆ—'], created_at: Date.now(), author_name:'KidneySphere'},
        ],
      };
      const rows = (demo[channel] || demo.case);
      list.innerHTML = rows.map(card).join('');
      maybeScrollHighlight();
      return;
    }

    const { data, error } = await supabase
      .from('cases')
      .select('id, title, board, summary, tags, created_at, author_id, author_name, like_count')
      .eq('board', boardKey)
      .order('created_at', { ascending: false })
      .limit(20);

    if(error){
      const em = String(error.message || '');
        const eml = em.toLowerCase();
        if(!currentUser && (eml.includes('permission') || eml.includes('rls') || eml.includes('jwt') || eml.includes('auth'))){
          const next = encodeURIComponent(location.pathname + location.search);
          location.href = `login.html?next=${next}`;
          return;
        }
        toast('è¯»å–å¤±è´¥', 'è¯·æ£€æŸ¥ Supabase æ˜¯å¦å·²å»ºè¡¨ casesï¼Œå¹¶è®¾ç½®å¥½ RLSã€‚é”™è¯¯ï¼š' + em, 'err');
      list.innerHTML = `<div class="note">æš‚æ— æ•°æ®ï¼ˆæˆ–å°šæœªå»ºè¡¨ï¼‰ã€‚</div>`;
      return;
    }

    if(!data || data.length===0){
      const emptyMsg = channel === 'case'
        ? 'æš‚æ— ç—…ä¾‹ã€‚ä½ å¯ä»¥å…ˆå‘å¸ƒä¸€ä¸ªä½œä¸ºæµ‹è¯•ã€‚'
        : (channel === 'literature' ? 'æš‚æ— æ–‡çŒ®è®¨è®ºã€‚ä½ å¯ä»¥å…ˆå‘å¸ƒä¸€æ¡æ–‡çŒ®å­¦ä¹ ä¸»é¢˜ã€‚' : 'æš‚æ— ç§‘ç ”è®¨è®ºä¸»é¢˜ã€‚ä½ å¯ä»¥å…ˆå‘å¸ƒä¸€ä¸ªç ”ç©¶é—®é¢˜/æƒ³æ³•ã€‚');
      list.innerHTML = `<div class="note">${emptyMsg}</div>`;
      return;
    }

    
      // Fetch favorites for listed cases
      let favedSet = new Set();
      if(currentUser && Array.isArray(data) && data.length){
        try{
          const ids = data.map(d => d.id);
          const { data: favRows, error } = await supabase
            .from('case_favorites')
            .select('case_id')
            .eq('user_id', currentUser.id)
            .in('case_id', ids);
          if(!error && Array.isArray(favRows)){
            favedSet = new Set(favRows.map(r => r.case_id));
          }
        }catch(_e){}
      }

      if(!data || data.length===0){
        list.innerHTML = `<div class="note">æš‚æ— å†…å®¹ã€‚ä½ å¯ä»¥ç‚¹å‡»å³ä¸Šè§’â€œå‘å¸ƒç—…ä¾‹â€å‘å¸ƒç¬¬ä¸€æ¡ç—…ä¾‹è®¨è®ºã€‚</div>`;
      }else{
        list.innerHTML = data.map(d => card(d, favedSet.has(d.id))).join('');
      maybeScrollHighlight();
      }

  }

  loadMeta();
  

    async function toggleCaseFavorite(btn){
      if(!currentUser){
        toast('éœ€è¦ç™»å½•', 'è¯·å…ˆç™»å½•åå†æ”¶è—ã€‚');
        return;
      }
      const caseId = Number(btn.getAttribute('data-fav-case'));
      if(!caseId) return;
      const isFaved = btn.getAttribute('data-faved') === '1';
      btn.disabled = true;
      try{
        if(isFaved){
          const { error } = await supabase
            .from('case_favorites')
            .delete()
            .eq('case_id', caseId)
            .eq('user_id', currentUser.id);
          if(error) throw error;
          btn.setAttribute('data-faved','0');
          btn.classList.remove('primary');
          btn.textContent = 'â­ æ”¶è—';
        }else{
          const row = { case_id: caseId, user_id: currentUser.id };
          const res = await supabase
            .from('case_favorites')
            .upsert(row, { onConflict: 'case_id,user_id', ignoreDuplicates: true });
          if(res?.error){
            const r2 = await supabase.from('case_favorites').insert(row);
            if(r2?.error){
              const msg = String(r2.error.message || r2.error);
              if(!(/duplicate key/i.test(msg) || String(r2.error.code || '') === '23505')) throw r2.error;
            }
          }
          btn.setAttribute('data-faved','1');
          btn.classList.add('primary');
          btn.textContent = 'â­ å·²æ”¶è—';
        }
      }catch(err){
        const msg = err?.message || String(err);
        if(/case_favorites/i.test(msg) && /(does not exist|relation|schema cache|could not find|not find)/i.test(msg)){
          toast('æ”¶è—åŠŸèƒ½æœªåˆå§‹åŒ–', 'è¯·åœ¨ Supabase SQL Editor è¿è¡Œ MIGRATION_20260110_FAVORITES.sqlï¼Œç„¶å Settings â†’ API ç‚¹å‡» â€œReload schemaâ€ã€‚');
        }else{
          toast('æ“ä½œå¤±è´¥', msg);
        }
      }finally{
        btn.disabled = false;
      }
    }

    // Favorite click: prevent navigation
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-fav-case]');
      if(!btn) return;
      e.preventDefault();
      e.stopPropagation();
      toggleCaseFavorite(btn);
    });

    
  // New case button (require login for posting; viewing is public)
  const btnNew = document.getElementById('btnNew');
  if(btnNew){
    // Button label
    if(channel === 'literature') btnNew.textContent = '+ å‘å¸ƒæ–‡çŒ®è®¨è®º';
    else if(channel === 'research') btnNew.textContent = '+ å‘å¸ƒç§‘ç ”è®¨è®º';
    else btnNew.textContent = '+ å‘å¸ƒç—…ä¾‹';

    btnNew.addEventListener('click', async (e) => {
      e.preventDefault();
      const target = (channel === 'case')
        ? `post-case.html?board=${encodeURIComponent(sectionKey)}`
        : `post-case.html?c=${encodeURIComponent(channel)}`;
      if(isConfigured()){
        const { data: { session } } = await supabase.auth.getSession();
        if(!session){
          location.href = `login.html?next=${encodeURIComponent(target)}`;
          return;
        }
      }
      location.href = target;
    });
  }

  load();
</script>

  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <img src="assets/logo.png" alt="logo" style="width:26px;height:26px;border-radius:8px">
          <b>KidneySphere Ã— KidneySphere AI</b>
        </div>
        <div class="small">ä»¥ç—…ä¾‹è®¨è®ºä¸å­¦ä¹ ä½“ç³»ä¸ºæ ¸å¿ƒï¼Œé€æ­¥å»ºè®¾å¯æ²‰æ·€ã€å¯æ£€ç´¢çš„è‚¾è„ç—…çŸ¥è¯†ç¤¾åŒºã€‚</div>
      </div>
      <div class="small">
        <div>Â© 2025 KidneySphere</div>
        <div style="margin-top:8px">è”ç³»ï¼š<a href="mailto:china@glomcon.org">china@glomcon.org</a></div>
      </div>
    </div>
  </footer>

  <div class="toast" data-toast></div>
  <script type="module" src="app.js?v=20260128_030"></script>
</body>
</html>
