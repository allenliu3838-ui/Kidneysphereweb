<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å­¦ä¹ ä¸­å¿ƒ Â· å…è´¹è§†é¢‘åº“ Â· KidneySphere</title>
  <meta name="description" content="KidneySphere Ã— KidneySphere AI">
  <link rel="icon" href="assets/logo.png" />
  <link rel="stylesheet" href="styles.css?v=20260213_001" />
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html" aria-label="KidneySphere Home">
        <img src="assets/logo.png" alt="KidneySphere AI Logo" />
        <div class="title">
          <b>è‚¾åŸŸAI Â· KidneySphereAI</b>
          <span>GlomConä¸­å›½ Ã— KidneySphere AI</span>
        </div>
      </a>

      <nav class="menu" aria-label="Primary">
        <a data-nav href="index.html"><span class="zh">é¦–é¡µ</span><span class="en">Home</span></a>
        <a data-nav href="community.html"><span class="zh">ç¤¾åŒºè®¨è®º</span><span class="en">Community</span></a>
        <a data-nav href="learning.html"><span class="zh">å­¦ä¹ ä¸­å¿ƒ</span><span class="en">Learning</span></a>
        <a data-nav href="frontier.html"><span class="zh">å‰æ²¿è¿›å±•</span><span class="en">Frontier</span></a>
        <a data-nav href="moments.html"><span class="zh">ç¤¾åŒºåŠ¨æ€</span><span class="en">Moments</span></a>
        <a data-nav href="events.html"><span class="zh">ä¼šè®®ä¸æ´»åŠ¨</span><span class="en">Events</span></a>
        <a data-nav href="research.html"><span class="zh">ä¸´åºŠç ”ç©¶ä¸­å¿ƒ</span><span class="en">Research</span></a>
        <a data-nav href="about.html"><span class="zh">å…³äº</span><span class="en">About</span></a>
      </nav>

      <div class="auth" data-auth>
        <a class="btn" href="login.html">ç™»å½•</a>
        <a class="btn primary" href="register.html">æ³¨å†Œ</a>
      </div>
    </div>
  </header>

  <main>

<section class="hero">
  <div class="container">
    <div class="card">
      <span class="badge">å­¦ä¹ ä¸­å¿ƒ Â· Videos</span>
      <h2 style="margin-top:10px">æ³¨å†Œç™»å½•åè§‚çœ‹ Â· å…è´¹è§†é¢‘åº“</h2>
      <p class="small">
        è¿™é‡Œæ”¶å½•ä½ æ•´ç†çš„å…¬å¼€å­¦ä¹ èµ„æºé“¾æ¥ï¼Œæ–¹ä¾¿æˆå‘˜åœ¨ä¸€ä¸ªåœ°æ–¹å­¦ä¹ ã€æ£€ç´¢ä¸æ²‰æ·€ã€‚
      </p>

      <div id="loginHint" class="note" style="margin-top:12px">
        æ­£åœ¨æ£€æµ‹ç™»å½•çŠ¶æ€â€¦
      </div>

      <div class="hr"></div>

      <div class="section-title">
        <div>
          <h3>é¢‘é“ç­›é€‰</h3>
          <p>ç‚¹å‡»é¢‘é“ç­›é€‰ã€‚è¿›å…¥æ’­æ”¾é¡µä¼šå¼ºåˆ¶è¦æ±‚ç™»å½•ï¼ˆç¬¦åˆâ€œæ³¨å†Œåè§‚çœ‹â€ï¼‰ã€‚</p>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn" href="learning.html">è¿”å›å­¦ä¹ ä¸­å¿ƒ</a>
        </div>
      </div>

      <div id="catPills" class="pills" style="margin-top:10px"></div>

      <div class="hr"></div>

      <div id="videoGrid" class="grid cols-3"></div>

      <div class="hr"></div>

      <div class="note small">
          <b>ç‰ˆæƒä¸åˆè§„ï¼š</b>æœ¬ç«™ä»…åšâ€œé“¾æ¥æ•´ç†ä¸å­¦ä¹ ç´¢å¼•â€ï¼Œä¸å­˜å‚¨/æ¬è¿è§†é¢‘å†…å®¹ã€‚
          <span data-admin-only hidden><br/>ç®¡ç†å‘˜æç¤ºï¼šå¦‚éœ€æ›´æ–°é™æ€æ¸…å•ï¼Œå¯ç¼–è¾‘ <code>assets/videos.js</code>ï¼›ä¹Ÿå¯åœ¨æœ¬é¡µçš„â€œç®¡ç†å‘˜ï¼šæ–°å¢è§†é¢‘â€ä¸­æ·»åŠ åˆ°æ•°æ®åº“ã€‚</span>
        </div>
    </div>
  </div>
</section>

<script type="module">
  import { supabase, ensureSupabase, isConfigured, toast } from './supabaseClient.js?v=20260128_030';
  import { VIDEO_CATEGORIES, FREE_VIDEOS } from './assets/videos.js?v=20260118_001';

  // v7.2: mix static "FREE_VIDEOS" with admin-added "learning_videos" (scheme 2)
  let DB_VIDEOS = [];
  let ALL_VIDEOS = [...FREE_VIDEOS];

  const qs = new URLSearchParams(location.search);
  let currentCat = (qs.get('cat') || 'all').toString();

  const catPills = document.getElementById('catPills');
  const grid = document.getElementById('videoGrid');
  const loginHint = document.getElementById('loginHint');

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function pill(label, active, onClick){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'pill-btn' + (active ? ' active' : '');
    btn.textContent = label;
    btn.addEventListener('click', onClick);
    return btn;
  }

  function setCat(cat){
    currentCat = cat;
    const url = new URL(location.href);
    if(cat === 'all') url.searchParams.delete('cat');
    else url.searchParams.set('cat', cat);
    history.replaceState({}, '', url.toString());
    renderCats();
    renderVideos();
  }

  function renderCats(){
    const all = [{ key: 'all', zh: 'å…¨éƒ¨', en: 'All' }, ...VIDEO_CATEGORIES];
    catPills.innerHTML = '';
    all.forEach(c => {
      const label = c.key === 'all' ? 'å…¨éƒ¨ / All' : `${c.zh} / ${c.en}`;
      catPills.appendChild(pill(label, currentCat === c.key, ()=> setCat(c.key)));
    });
  }

  function videoCard(v){
    const kind = v.kind || (v.bvid ? 'bilibili' : 'external');
    const badge = v.needs_check ? `<span class="badge" style="border-color:rgba(255,160,160,.5);background:rgba(255,160,160,.08)">å¾…æ ¸å¯¹</span>` : '';
    const speaker = (v.speaker || '').trim();
    const metaLine = speaker ? `ä¸»è®²ï¼š${esc(speaker)}` : `åˆ†ç±»ï¼š${esc(v.category || '')}`;
    const openText = kind === 'mp4' ? 'æ‰“å¼€è§†é¢‘' : (kind === 'external' ? 'æ‰“å¼€é“¾æ¥' : 'æ‰“å¼€Bç«™');
    const openUrl = v.mp4_url || v.source_url || '';
    const canOpen = !!openUrl;
    return `
      <div class="card soft">
        <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <h3 style="margin:0">${esc(v.title || '')}</h3>
            <div class="small muted" style="margin-top:6px">${metaLine}</div>
          </div>
          ${badge}
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <a class="btn primary" href="watch.html?id=${encodeURIComponent(v.id)}">è§‚çœ‹ï¼ˆéœ€ç™»å½•ï¼‰</a>
          ${canOpen ? `<a class="btn" href="${esc(openUrl)}" target="_blank" rel="noopener">${openText}</a>` : ''}
        </div>
      </div>
    `;
  }

  function renderVideos(){
    const list = (currentCat === 'all')
      ? ALL_VIDEOS
      : ALL_VIDEOS.filter(v => v.category === currentCat);

    if(!list || list.length === 0){
      grid.innerHTML = `<div class="note">è¯¥é¢‘é“æš‚æ— è§†é¢‘å†…å®¹ã€‚</div>`;
      return;
    }

    grid.innerHTML = list.map(videoCard).join('');
  }

  async function renderLoginHint(){
    if(!isConfigured() || !supabase){
      loginHint.innerHTML = `<b>æç¤ºï¼š</b>å½“å‰æœåŠ¡æš‚ä¸å¯ç”¨ï¼ˆç³»ç»Ÿåˆå§‹åŒ–ä¸­ï¼‰ã€‚å¦‚éœ€â€œç™»å½•åè§‚çœ‹â€ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å®Œæˆé…ç½®ã€‚`;
      return;
    }

    try{
      const { data: { session } } = await supabase.auth.getSession();
      if(session?.user){
        const u = session.user;
        loginHint.innerHTML = `âœ… å·²ç™»å½•ï¼š<b>${esc(u.email || u.phone || u.id)}</b>ã€‚ä½ å¯ä»¥ç›´æ¥è¿›å…¥æ’­æ”¾é¡µè§‚çœ‹ã€‚`;
      }else{
        loginHint.innerHTML = `ğŸ”’ ä½ å½“å‰æœªç™»å½•ã€‚ä½ ä»å¯æµè§ˆç›®å½•ï¼Œä½†ç‚¹å‡»â€œè§‚çœ‹â€ä¼šå¼•å¯¼ä½ å…ˆç™»å½•/æ³¨å†Œã€‚`;
      }
    }catch(e){
      loginHint.innerHTML = `âš ï¸ ç™»å½•çŠ¶æ€è¯»å–å¤±è´¥ï¼š${esc(e?.message || 'æœªçŸ¥é”™è¯¯')}ã€‚å»ºè®®ç”¨æ— ç—•çª—å£é‡è¯•ï¼Œæˆ–æ¸…ç†ç«™ç‚¹å­˜å‚¨åå†ç™»å½•ã€‚`;
    }
  }

  async function loadDbVideos(){
    DB_VIDEOS = [];
    ALL_VIDEOS = [...FREE_VIDEOS];

    if(!isConfigured()) return;
    await ensureSupabase();
    if(!supabase) return;

    try{
      const { data, error } = await supabase
        .from('learning_videos')
        .select('id,title,category,kind,source_url,mp4_url,bvid,speaker,created_at,enabled,deleted_at')
        .eq('enabled', true)
        .is('deleted_at', null)
        .order('created_at', { ascending: false })
        .limit(200);

      if(error) throw error;

      DB_VIDEOS = (data || []).map(v => ({
        id: String(v.id),
        title: v.title || '',
        speaker: v.speaker || '',
        category: v.category || 'other',
        kind: v.kind || (v.bvid ? 'bilibili' : 'external'),
        bvid: v.bvid || null,
        source_url: v.source_url || v.mp4_url || '',
        mp4_url: v.mp4_url || null,
      }));

      ALL_VIDEOS = [...FREE_VIDEOS, ...DB_VIDEOS];
    }catch(e){
      // If table not migrated yet, silently keep static list.
      const msg = String(e?.message || e || '');
      if(/relation .*learning_videos.* does not exist/i.test(msg)) return;
      toast('åŠ è½½è§†é¢‘å¤±è´¥', msg, 'err');
    }
  }

  async function init(){
    renderCats();
    await loadDbVideos();
    renderVideos();
    renderLoginHint();
  }

  init();
</script>

  </main>

  <footer class="footer">
    <div class="container footer-grid">
      <div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
          <img src="assets/logo.png" alt="logo" style="width:26px;height:26px;border-radius:8px">
          <b>KidneySphere Ã— KidneySphere AI</b>
        </div>
        <div class="small">å½“å‰ç‰ˆæœ¬ Â· ä»¥â€œç—…ä¾‹è®¨è®º + å­¦ä¹ ä¸­å¿ƒ + å‰æ²¿è¿›å±•â€ä¸ºæ ¸å¿ƒï¼ŒæŒç»­è¿­ä»£å®Œå–„ã€‚</div>
      </div>
      <div class="small">
        <div>Â© 2025 KidneySphere</div>
        <div style="margin-top:8px">è”ç³»ï¼š<a href="mailto:china@glomcon.org">china@glomcon.org</a></div>
      </div>
    </div>
  </footer>

  <div class="toast" data-toast></div>
  <script type="module" src="app.js?v=20260128_030"></script>
</body>
</html>
